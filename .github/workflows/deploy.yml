name: Build and Deploy

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  DOCKER_IMAGE: veiag/cxntury-api:latest

jobs:
  build:
    name: Build All Applications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Build everything using Turbo - if any fails, job fails
      # API: ncc bundles everything into single file with all dependencies
      # Frontend: Vite builds static files
      - name: Build all with Turbo
        run: pnpm turbo build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      # If we got here, both builds succeeded!
      - name: Build status
        run: echo "‚úÖ All builds completed successfully"

      # Prepare migration files for Docker image
      - name: Prepare migration files
        run: |
          cp -r apps/api/src/migrations apps/api/dist/
          cp apps/api/src/config/database.config.js apps/api/dist/

      # Upload API dist for Docker build
      - name: Upload API build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-dist
          path: apps/api/dist
          retention-days: 1

      # Upload frontend dist for FTP deployment
      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
          retention-days: 1

  docker-build:
    name: Build and Push Docker Image
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download API build artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-dist
          path: apps/api/dist

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}
          cache-to: type=inline
          # Note: No build happens here - just copying pre-built ncc bundle

  deploy:
    name: Deploy to Server
    needs: [build, docker-build]
    runs-on: ubuntu-latest

    steps:
      - name: Download frontend build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: dist

      - name: Deploy frontend via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: './'
          dangerous-clean-slate: false # Prevent deleting acme challenge files

      - name: Notify deployment success
        run: |
          echo "üöÄ Deployment completed successfully!"
          echo "‚úÖ Docker image: veiag/cxntury-api:latest"
          echo "‚úÖ Frontend deployed via FTP"

  deploy-failure:
    name: Deployment Failed
    needs: [build, docker-build, deploy]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Notify failure
        run: |
          echo "‚ùå Deployment failed!"
          echo "Nothing was deployed - atomic deployment prevented partial deployment."
